# Документация

## Типы архивов

Я нигде не встречал описание правил, согласно которому релиз группы должны упаковывать свои релизы, но судя по моему опыту вот с чем мы можем столкнуться:

1. Все внешние архивы имеют формат `rar`
   - Судя по тому, в каких форматах я скачивал файлы с популярных варез-сайтов - все внешние архивы (то есть файлы-архивы которые вы скачиваете, внутри которых находились другие мелкие архивы) имеют расширение `.rar`
   - Один мой друг, который публиковал материал на sanet сказал мне, что на тот сайт допускаются архивы только в формате `.rar`
2. Внутренность архивов не имеет четкой структуры

Если вы скачиваете архивы с публичных и популярных варез-сайтов, то, скорее всего, внутри таких архивов не будет множество мелких архивов, а будут уже непосредственно файлы готовые к использованию. Достаточно будет распаковать этот скачанный архив и все готово.

Если вы скачиваете архивы с зеркальных сервисов для сцен или с самих сцен, то, скорее всего, внутри таких архивов будет множество мелких архивов, внутри которых могут быть как нужные вам файлы, так и другие мелкие архивы или части 1 большого архива.

Я видел несколько вариантов такой упаковки мелких архивов.

## Возможные структуры архивов с частями внутри

Основной/внешний архив, который мы скачиваем это как правило 1 rar-архив.

Но то, что нам нужно находится внутри и не сразу в готовом виде. Весь набор файлов релиза (например программа в exe-формате и файл .nfo) сжимается в rar-архив с параметром разделения на части определенного размера. Потом все эти части + файл .nfo + файл file_id.diz упаковывают в обычный rar-архив без какого-либо разделения.

Вот какие варианты упаковки мелких архивов в 1 общий архив:

1. Релиз упакован в rar-архив разделенный на части с расширением `.rXX` на конце
```
best.app.rar
├ best.app.rar
├ best.app.r00
├ best.app.r01
├ some.team.nfo
└ file_id.diz
```
И при распаковке частей rar-архива, то есть файлов `.rXX` мы получим файлы релиза.

2. Релиз упакован в rar-архив разделенный на части с расширением `.partXX.rar` на конце
```
best.app.rar
├ best.app.part1.rar
├ best.app.part2.rar
├ best.app.part3.rar
├ some.team.nfo
└ file_id.diz
```
И при распаковке частей rar-архива, то есть файлов `.partXX.rar` мы получим файлы релиза.

3. Тоже, что и вариант 1, но каждая часть вместе с `.nfo` и `.diz` файлами упакована в zip-архив.
```
best.app.rar
├ best.app-1.zip
│ ├ best.app.rar
│ ├ some.team.nfo
│ └ file_id.diz
├ best.app-2.zip
│ ├ best.app.r00
│ ├ some.team.nfo
│ └ file_id.diz
├ best.app-3.zip
│ ├ best.app.r00
│ ├ some.team.nfo
│ └ file_id.diz
├ some.team.nfo
└ file_id.diz
```
И сначала необходимо распаковать все zip-архивы, решая конфликты слияния (то есть выбирая заменять файлы `.nfo` и `.diz` на те, что есть архиве или пропустить замену), а потом уже распаковывать rar-архив разделенный на части

4. Тоже, что и вариант 2, но каждая часть вместе с `.nfo` и `.diz` файлами упакована в zip-архив.
```
best.app.rar
├ best.app-1.zip
│ ├ best.app.part1.rar
│ ├ some.team.nfo
│ └ file_id.diz
├ best.app-2.zip
│ ├ best.app.part2.rar
│ ├ some.team.nfo
│ └ file_id.diz
├ best.app-3.zip
│ ├ best.app.part3.rar
│ ├ some.team.nfo
│ └ file_id.diz
├ some.team.nfo
└ file_id.diz
```
И сначала необходимо распаковать все zip-архивы, решая конфликты слияния (то есть выбирая заменять файлы `.nfo` и `.diz` на те, что есть архиве или пропустить замену), а потом уже распаковывать rar-архив разделенный на части

> Разница между частями rar-архива в формате `.rXX` и `.partXX.rar` заключается в том, что части `.rXX` это формат RAR4 и он считается устаревшим и начиная с WinRAR 7 создание rar-архива разделенного на такие части больше не поддерживается. Формат частей `.partXX.rar` считается современным и именно в таком формате создаются части rar-архива в WinRAR 7 (ну и в предыдущих версиях тоже).

### Дополнительные нюансы:

Также стоит учитывать, что:

1. В корне каждого архива файлы могут находится в папке, а могут лежать кучей в самом архиве без какой-либо папки.
   - это может создать огромную вложенность и огромное количество папок, если частей много
2. Все это может измениться и быть кем-либо переупаковано и вместо частей rar-архивов там могут быть части zip-архивов или 7z-архивов
   - части zip-архива тоже могут быть как в формате `.zXX`, так и в `.zip.XXX`. Возможно и части 7z-архивов могут иметь несколько форматов
3. При открытии частей архива в файловом менеджере, при клике на какую-либо не-первую часть разделенного архива - архиватор автоматически находит первую часть и начинает анализ и открытие архива с первой части. Но если в CLI режиме архиватору указать для распаковки не первую часть, то он не будет искать первую, а попытается распаковать конкретно переданный файл
   - То есть искать первую часть архива и передавать ее архиватору понадобится самостоятельно

Суть скрипта, чтобы обработать все возможные нюансы и не тратить время на распаковку всех частей вручную.

## Умное переименование

Все названия архивов с релизами материала со сцен, которые я видел - не имеют пробелов. В качестве разделителя там либо точка, либо нижнее тире или подчеркивание.

Например:
```
WE.ARE.FOOTBALL.2024.Season.2024.2025-SKIDROW
Speedollama-rG
Drova_Forsaken_Kin_MacOS-DINOByTES
Safari.Pedals.Everything.Bundle.v2024.10.14.MacOS.UB.Incl.Keygen.VST-BTCR
Valentina.Server.v14.6.0.Linux.x64.RPM.Incl.Keyfilemaker-CORE
Rail.Route.Happy.Passengers.MacOS-I_KnoW
```

Я не знаю по какому принципу происходит именование архивов и папок с релизами, но точки и нижнее подчеркивание вместо пробелов между слов не всегда удобно. Поэтому в скрипте также есть функция "умное переименование", которая как раз будет заменять точки, тире и нижнее подчеркивание на пробелы или другие символы, там где это необходимо.

Эта функция включается добавлением аргумента `-smartRenameMode` и передачей ему цифры от 0 или более. Цифра обозначает версию режима переименования, который будет применяться.

Переименование будет использоваться для основных/внешних папок в которых будут находиться файлы релиза, извлеченные из основного/внешнего.

### Какие есть режимы переименования

- 0 - без переименования
- 1 - точки заменяются на пробелы только там, где с обеих сторон точки не цифры. Все нижние подчеркивания идущие по последнего тире - заменяются на пробелы. Последнее тире заменяется на пробелы

Например
```
Safari.Pedals.Everything.Bundle.v2024.10.14.MacOS.UB.Incl.Keygen.VST-BTCR
>
Safari Pedals Everything Bundle v2024.10.14 MacOS UB Incl Keygen VST BTCR

Drova_Forsaken_Kin_MacOS-DINOByTES
>
Drova Forsaken Kin MacOS DINOByTES

Rail.Route.Happy.Passengers.MacOS-I_KnoW
>
Rail Route Happy Passengers MacOS I_KnoW
```

- 2 - тоже, что и версия 1, только текст после последнего тире будет заключен в квадратные скобки

Например
```
Safari.Pedals.Everything.Bundle.v2024.10.14.MacOS.UB.Incl.Keygen.VST-BTCR
>
Safari Pedals Everything Bundle v2024.10.14 MacOS UB Incl Keygen VST [BTCR]

Drova_Forsaken_Kin_MacOS-DINOByTES
>
Drova Forsaken Kin MacOS [DINOByTES]

Rail.Route.Happy.Passengers.MacOS-I_KnoW
>
Rail Route Happy Passengers MacOS [I_KnoW]
```

- 3 - заменить вообще все точки, все тире и все нижние подчеркивания на пробелы

Например
```
Safari.Pedals.Everything.Bundle.v2024.10.14.MacOS.UB.Incl.Keygen.VST-BTCR
>
Safari Pedals Everything Bundle v2024 10 14 MacOS UB Incl Keygen VST BTCR

Drova_Forsaken_Kin_MacOS-DINOByTES
>
Drova Forsaken Kin MacOS DINOByTES

Rail.Route.Happy.Passengers.MacOS-I_KnoW
>
Rail Route Happy Passengers MacOS I KnoW
```

## Выявленные нюансы

1. Не используйте `rar.exe` и `unrar.exe` для распаковки zip-архивов. Они предназначены для работы только с rar-архивами и zip-архивы будут рассматривать как самораспаковывющиеся SFX-архивы и будут с ними работать неправильно.
   - Чтобы распаковать zip-архивы с помощью WinRAR, необходимо использовать WinRAR.exe в консольном режиме, но она не показывает никакую документацию при выполнении команды `WinRAR.exe --help` и выдает ошибку при этом.
   - Поэтому чтобы скрипт корректно поддерживал несколько архиваторов, необходимо перед каждой распаковкой добавлять проверку расширения архива и если это zip-архив проверять какой архиватор мы используем и если это `rar.exe` или `unrar.exe`, то переключаться на другой только для распаковки zip и 7z архивов
   - Также между `7z.exe` есть и другие отличия, например для указания папки для распаковки в `7z` используется `-o{Directory}`, а в RAR используется `-op{Directory}`
   - Это и другие непонятные проблемы при использовании WinRAR в консольном режиме привели к тому, что его использование в скрипте добавит слишком много уловных операторов и уменьшит читаемость кода
2. В Bandizip утилита `bz.exe` почему-то не реагирует на папку для распаковки, если указывать ее в формате `-o{Directory}` или `-o:{Directory}`.
   - чтобы указанный путь для распаковки использовался, необходимо его писать в конце команды без всяких префиксов
   - это накладывает дополнительные условия при распаковки, поэтому я решил отказаться от поддержки `bz.exe`
3. Желательно как можно меньше подвергать изменениям целевые файлы релиза. Чтобы их дата создания/изменения и другие атрибуты не были затронуты. Это может когда-нибудь пригодится.